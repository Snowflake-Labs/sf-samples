USE ROLE <% ctx.env.finops_db_admin_role%>;
USE DATABASE <% ctx.env.finops_acct_db %>;
USE SCHEMA <% ctx.env.finops_acct_schema %>;
CREATE OR REPLACE VIEW ORGV1_SERVICE_ACCOUNT_CURRENCY_DAY COMMENT = 'Title: Organizational service usage in currency by account per day. Description: Organizational usage by service in currency.'
AS
SELECT
   USAGE_DATE,
   ACCOUNT_NAME,
   CONCAT_WS('-', REGION, ACCOUNT_NAME) AS REGION_ACCOUNT_NAME,
   SERVICE_TYPE AS USAGE_TYPE,
   SUM(USAGE_IN_CURRENCY) USAGE_IN_CURRENCY
FROM SNOWFLAKE.ORGANIZATION_USAGE.USAGE_IN_CURRENCY_DAILY
-- Potentially limit to contract start_date in ORGANIZATION_USAGE.CONTRACT_ITEMS
GROUP BY ALL
HAVING SUM(USAGE_IN_CURRENCY) > 0
UNION ALL
SELECT
   USAGE_DATE,
   ACCOUNT_NAME,
   CONCAT_WS('-', REGION, ACCOUNT_NAME) AS REGION_ACCOUNT_NAME,
   'DAILY TOTAL' USAGE_TYPE,
   SUM(USAGE_IN_CURRENCY) USAGE_IN_CURRENCY
FROM SNOWFLAKE.ORGANIZATION_USAGE.USAGE_IN_CURRENCY_DAILY
GROUP BY ALL
HAVING SUM(USAGE_IN_CURRENCY) > 0;
