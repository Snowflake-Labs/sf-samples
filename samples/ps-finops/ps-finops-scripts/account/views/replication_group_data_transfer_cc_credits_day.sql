USE ROLE <% ctx.env.finops_db_admin_role%>;
USE DATABASE <% ctx.env.finops_acct_db %>;
USE SCHEMA <% ctx.env.finops_acct_schema %>;
CREATE OR REPLACE VIEW REPLICATION_GROUP_DATA_TRANSFER_CC_CREDITS_DAY COMMENT = 'Title: Replication Group Data Transfer Use by Cost Center per day. Description: Analyze replication group credit costs by cost center per day.'
AS
SELECT
   DATE(START_TIME)                  AS DAY,
   COALESCE(TD.TAG_VALUE, REPLICATION_GROUP_NAME) AS COST_CENTER,
   'REPLICATION_GROUPS'                 AS SERVICE_TYPE,
   SUM(BYTES_TRANSFERRED)/POWER(1024,3) AS TB_TRANSEFERRED, -- TOTAL DATA TRANSFERRED IN TB FOR THIS DAY.
   SUM(CREDITS_USED)                 AS CREDITS_USED  -- TOTAL CREDITS USED FOR REPLICATION FOR THIS DAY.
FROM   SNOWFLAKE.ACCOUNT_USAGE.REPLICATION_GROUP_USAGE_HISTORY UH
LEFT JOIN SNOWFLAKE.ACCOUNT_USAGE.TAG_REFERENCES TD
   ON TD.OBJECT_NAME = UH.REPLICATION_GROUP_NAME
   AND TD.TAG_NAME = '<% ctx.env.finops_tag_name %>'
   AND TD.DOMAIN = 'REPLICATION GROUP'
GROUP BY ALL;
