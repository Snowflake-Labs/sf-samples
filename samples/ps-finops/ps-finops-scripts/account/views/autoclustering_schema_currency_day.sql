USE ROLE <% ctx.env.finops_db_admin_role%>;
USE DATABASE <% ctx.env.finops_acct_db %>;
USE SCHEMA <% ctx.env.finops_acct_schema %>;
CREATE OR REPLACE VIEW AUTOCLUSTERING_SCHEMA_CURRENCY_DAY COMMENT = 'Title: Automatic Clustering (AC) Credit Usage by Cost Center per day. Description: Analyze automatic clustering costs by schema and cost center per day.'
AS

WITH MR
AS (
   -- RETRIEVE METERING RATES PER DATE
   SELECT MAX(EFFECTIVE_RATE) AS METERING_RATE, DATE
   FROM SNOWFLAKE.ORGANIZATION_USAGE.RATE_SHEET_DAILY RS
   WHERE SERVICE_TYPE = 'WAREHOUSE_METERING'
       AND IS_ADJUSTMENT = FALSE
       AND ACCOUNT_LOCATOR = CURRENT_ACCOUNT()
       AND RS.DATE > (
           SELECT MIN(START_DATE)
           FROM SNOWFLAKE.ORGANIZATION_USAGE.CONTRACT_ITEMS
           WHERE START_DATE <= CURRENT_DATE()
            AND CONTRACT_ITEM IN ('Capacity', 'Additional Capacity')
            AND NVL(EXPIRATION_DATE, '2999-01-01') > END_DATE
           )
    GROUP BY DATE
   )
SELECT
   DATE_TRUNC('DAY', ACH.START_TIME) AS DAY,
   COALESCE(TS.TAG_VALUE, 'SCHEMA:' || ACH.DATABASE_NAME || '.' || ACH.SCHEMA_NAME) COST_CENTER,
   ACH.DATABASE_NAME,
   ACH.SCHEMA_NAME,
   ROUND(SUM(CREDITS_USED * MR.METERING_RATE), 2) AS AC_COST_CURRENCY, -- TOTAL AUTOMATIC CLUSTERING COST IN RESPECTIVE CURRENCY FOR THIS DAY.
   ROUND(SUM(NUM_BYTES_RECLUSTERED) / POWER(2, 30), 1) AS RECLUSTERED_GB, -- RECLUSTERED DATA IN GB FOR THIS DAY.
   ROUND(SUM(NUM_BYTES_RECLUSTERED) / POWER(2, 40), 1) AS RECLUSTERED_TB, -- RECLUSTERED DATA IN TB FOR THIS DAY.
   ROUND(SUM(NUM_ROWS_RECLUSTERED) / POWER(10, 6), 1) AS RECLUSTERED_ROWS_MM -- HOW MANY ROWS AFFECTED BY RECLUSTERED DATA IN TB FOR THIS DAY.
FROM SNOWFLAKE.ACCOUNT_USAGE.AUTOMATIC_CLUSTERING_HISTORY ACH
JOIN MR ON MR.DATE = DAY
LEFT JOIN SNOWFLAKE.ACCOUNT_USAGE.TAG_REFERENCES TS ON TS.OBJECT_DATABASE = ACH.DATABASE_NAME
   AND TS.OBJECT_NAME = ACH.SCHEMA_NAME
   AND TS.TAG_NAME = '<% ctx.env.finops_tag_name %>'
   AND TS.DOMAIN = 'SCHEMA'
GROUP BY ALL;