-- Note: Using organization_usage schema for ORG 2.0 Views
USE ROLE <% ctx.env.finops_db_admin_role%>;
USE DATABASE <% ctx.env.finops_acct_db %>;
USE SCHEMA <% ctx.env.finops_acct_schema %>;
CREATE OR REPLACE VIEW ORG_TABLE_RECREATION_SCHEMA_COUNT_DAY COMMENT = 'Title: Table Recreation Counts by Schema. Description: Analyze tables that are recreated by schema.'
as
WITH MAX_DATE
AS
   (
   SELECT MAX(DATE_COLLECTED) AS LATEST_SNAPSHOT
   FROM TABLE_STORAGE_DETAILED
   )
SELECT DISTINCT
   COALESCE(TS.TAG_VALUE, TABLE_SCHEMA) COST_CENTER,
   TSD.ACCOUNT_LOCATOR,
   TSD.ACCOUNT_NAME,
   TABLE_CATALOG || '.' || TABLE_SCHEMA AS SCHEMA_NAME,
   TABLE_COPY_COUNT - 1 AS TABLE_RECREATED_COUNT
FROM TABLE_STORAGE_DETAILED_ORG TSD  -- GENERATED TABLE STORAGE DETAILED METRICS
LEFT JOIN SNOWFLAKE.ORGANIZATION_USAGE.TAG_REFERENCES TS
   ON TS.OBJECT_DATABASE = TSD.TABLE_CATALOG
      AND TSD.ACCOUNT_LOCATOR = TS.ACCOUNT_LOCATOR
      AND TS.OBJECT_NAME = TSD.TABLE_SCHEMA
      AND TS.TAG_NAME = '<% ctx.env.finops_tag_name %>'
      AND TS.DOMAIN = 'SCHEMA'
WHERE DATE_COLLECTED = (
       SELECT LATEST_SNAPSHOT
       FROM MAX_DATE
       )
GROUP BY ALL;
