-- Note: Using organization_usage schema for ORG 2.0 Views
USE ROLE <% ctx.env.finops_db_admin_role%>;
USE DATABASE <% ctx.env.finops_acct_db %>;
USE SCHEMA <% ctx.env.finops_acct_schema %>;
CREATE OR REPLACE VIEW ORG_SNOWPIPE_COSTS_CC_CREDITS_DAY COMMENT = 'Title: Snowpipe Credits by Schema per cost center.'
AS
SELECT
   DATE_TRUNC('DAY', H.USAGE_DATE) AS DAY
   , H.ACCOUNT_NAME
   , COALESCE(TS.TAG_VALUE, PIPE_SCHEMA, 'UNKNOWN') AS COST_CENTER
   , P.PIPE_CATALOG || '.' || P.PIPE_SCHEMA AS PIPE_SCHEMA
   , SUM(CREDITS_USED) AS CREDITS_USED,
--    , SUM(FILES_INSERTED) AS TOTAL_FILES_INGESTED,
--    CASE
--        WHEN TOTAL_FILES_INGESTED > 0
--            THEN (SUM(BYTES_INSERTED) / TOTAL_FILES_INGESTED) / POWER(1024, 2)
--        ELSE 0
--        END AS AVG_MB_PER_FILE   -- Average MB of data per file size for the pipe schema on this day.
FROM SNOWFLAKE.ORGANIZATION_USAGE.PIPE_USAGE_HISTORY H
INNER JOIN SNOWFLAKE.ORGANIZATION_USAGE.PIPES P
    ON H.PIPE_ID = P.PIPE_ID
        AND H.ACCOUNT_LOCATOR = P.ACCOUNT_LOCATOR
LEFT JOIN SNOWFLAKE.ORGANIZATION_USAGE.TAG_REFERENCES TS
    ON TS.OBJECT_DATABASE = P.PIPE_CATALOG
        AND TS.ACCOUNT_LOCATOR = H.ACCOUNT_LOCATOR
        AND TS.OBJECT_NAME = P.PIPE_SCHEMA
        AND TS.TAG_NAME = '<% ctx.env.finops_tag_name %>'
        AND TS.DOMAIN = 'SCHEMA'
GROUP BY ALL;
