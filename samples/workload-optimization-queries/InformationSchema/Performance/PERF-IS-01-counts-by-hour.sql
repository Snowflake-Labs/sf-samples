-------------------------------------------------
-- NAME:	 PERF-IS-01-counts-by-hour.txt
-------------------------------------------------
-- DESCRIPTION:
--	VARIOUS SQL TO SLICE 'N DICE REQUEST COUNTS
--
-- OUTPUT:
--	UNDERSTANDING VOLUME OF STATEMENT TYPES BY VARIOUS VIEWS
--
-- NEXT STEPS:
--	LOOK FOR OUTLIERS TO NARROW PERFORMANCE ANALYSIS TO DISCOVER ISSUE
--
-- OPTIONS:
--	NARROW ANALYSIS BASED ON A TIMEFRAMES VOLUME OF REQUESTS
--	NARROW ANALYSIS BASED ON STATEMENT TYPE VOLUME OF REQUESTS
--	DRILLDOWN TO WAREHOUSE LEVEL FOR SAME INSIGHTS
--
-- REVISION HISTORY
-- DATE		INIT	DESCRIPTION
----------  ----    -----------
-- 18JAN22	WNA		created/updated for repository
-------------------------------------------------
	
--------------------------------------
-- ACCOUNT HOUR REQUEST COUNTS
--
-- DETERMINE ACCOUNT TO DRILL DOWN ON
-- SET ACCOUNT_NAME WITH THAT ACCOUNT FOR NEXT QUERY
--------------------------------------
SELECT
    TO_CHAR(MONTH(START_TIME),'00')||
    TO_CHAR(DAY(START_TIME),'00')||
    TO_CHAR(HOUR(START_TIME),'00') AS DAY_HOUR,
    $ACCOUNT_NAME AS ACCOUNT_NAME,
    COUNT(*)
FROM
	TABLE(SNOWFLAKE.INFORMATION_SCHEMA.QUERY_HISTORY(
		END_TIME_RANGE_START=>dateadd('day',-6,current_timestamp()),
		END_TIME_RANGE_END=>current_timestamp()))
GROUP BY
    1
HAVING COUNT(*)>1000
ORDER BY
    1
;

--------------------------------------
-- ACCOUNT WH HOUR REQUEST COUNTS
--
-- DETERMINE WAREHOUSE TO DRILL DOWN ON
-- CREATE IN LIST FOR NEXT QUERY
--------------------------------------

SELECT
    TO_CHAR(MONTH(START_TIME),'00')||
    TO_CHAR(DAY(START_TIME),'00')||
    TO_CHAR(HOUR(START_TIME),'00') AS DAY_HOUR,
    WAREHOUSE_NAME,
    COUNT(*)
FROM
	TABLE(SNOWFLAKE.INFORMATION_SCHEMA.QUERY_HISTORY(
		END_TIME_RANGE_START=>dateadd('day',-6,current_timestamp()),
		END_TIME_RANGE_END=>current_timestamp()))
GROUP BY
    1,2
HAVING COUNT(*)>1000
ORDER BY
    1,2
;


--------------------------------------
-- ACCOUNT WH USER HOUR REQUEST COUNTS
--------------------------------------
SELECT
    TO_CHAR(MONTH(START_TIME),'00')||
    TO_CHAR(DAY(START_TIME),'00')||
    TO_CHAR(HOUR(START_TIME),'00') AS DAY_HOUR,
    WAREHOUSE_NAME||'~'||USER_NAME AS WH_USER,
    COUNT(*)
FROM
	TABLE(SNOWFLAKE.INFORMATION_SCHEMA.QUERY_HISTORY(
		END_TIME_RANGE_START=>dateadd('day',-6,current_timestamp()),
		END_TIME_RANGE_END=>current_timestamp()))
WHERE
    WAREHOUSE_NAME = $WAREHOUSE_NAME
GROUP BY
    1,2
ORDER BY
    1,2
;