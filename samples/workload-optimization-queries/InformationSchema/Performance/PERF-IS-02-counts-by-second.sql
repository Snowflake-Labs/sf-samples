-------------------------------------------------
-- NAME:	 PERF-IS-02-counts-by-second.txt
-------------------------------------------------
-- DESCRIPTION:
--	VARIOUS SQL TO SLICE 'N DICE REQUEST COUNTS
--
-- OUTPUT:
--	UNDERSTANDING VOLUME OF STATEMENT TYPES BY VARIOUS VIEWS
--
-- NEXT STEPS:
--	LOOK FOR OUTLIERS TO NARROW PERFORMANCE ANALYSIS TO DISCOVER ISSUE
--
-- OPTIONS:
--	NARROW ANALYSIS BASED ON A TIMEFRAMES VOLUME OF REQUESTS
--	NARROW ANALYSIS BASED ON STATEMENT TYPE VOLUME OF REQUESTS
--	DRILLDOWN TO WAREHOUSE LEVEL FOR SAME INSIGHTS
--
-- REVISION HISTORY
-- DATE		INIT	DESCRIPTION
----------  ----    -----------
-- 18JAN22	WNA		created/updated for repository
-------------------------------------------------
	
--------------------------------------
-- ACCOUNT WH SECONDS REQUEST COUNTS
--
-- DETERMINE WAREHOUSE TO DRILL DOWN ON FROM HOUR SCRIPT
-- CREATE IN LIST FOR NEXT QUERY
-- ALSO NARROW DOWN THE TIME
--------------------------------------
SELECT
    TO_CHAR(HOUR(START_TIME),'00')||
    TO_CHAR(SECOND(START_TIME),'00') AS DAY_HOUR,
    WAREHOUSE_NAME,
    COUNT(*)
FROM
	TABLE(SNOWFLAKE.INFORMATION_SCHEMA.QUERY_HISTORY(
		END_TIME_RANGE_START=>dateadd('day',-6,current_timestamp()),
		END_TIME_RANGE_END=>current_timestamp()))
WHERE
    WAREHOUSE_NAME = $WAREHOUSE_NAME
GROUP BY
    1,2
ORDER BY
    1,2
;

--------------------------------------
-- ACCOUNT WH HOUR REQUEST COUNTS
-- BY SECOND AND STATEMENT TYPE
--------------------------------------
SELECT
    TO_CHAR(HOUR(START_TIME),'00')||
    TO_CHAR(SECOND(START_TIME),'00') AS DAY_HOUR,
    STATEMENT_TYPE,
    COUNT(*)
FROM
	TABLE(SNOWFLAKE.INFORMATION_SCHEMA.QUERY_HISTORY(
		END_TIME_RANGE_START=>dateadd('day',-6,current_timestamp()),
		END_TIME_RANGE_END=>current_timestamp()))
WHERE
    WAREHOUSE_NAME = $WAREHOUSE_NAME
GROUP BY
    1,2
ORDER BY
    1,2
;