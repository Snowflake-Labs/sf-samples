-------------------------------------------------
-- NAME:	 PERF-AU-22-dml-stats.txt
-------------------------------------------------
-- DESCRIPTION:
--	Processing metrics for DML
--
-- OUTPUT:
--	Query and session context information
--	Data loading metadata
--	Processing performance metrics
--
-- NEXT STEPS:
--	If load logic issue occurred, then use information to troubleshoot
--	If performance issue, then use information to optimize process
--
-- OPTION:
--	Add query tag to processing, then use data for data integration monitoring
--
-- REVISION HISTORY
-- DATE		INIT	DESCRIPTION
----------  ----    -----------
-- 18JAN22	WNA		CREATED/UPDATED FOR REPOSITORY
-------------------------------------------------
	
SELECT
	-- HEADER
	QUERY_ID,
    QUERY_TYPE,
	QUERY_TEXT,
	DATABASE_NAME,
	SCHEMA_NAME,
	SESSION_ID,
	USER_NAME,
	ROLE_NAME,
	WAREHOUSE_NAME,
	WAREHOUSE_SIZE,
	WAREHOUSE_TYPE,
	CLUSTER_NUMBER,
	QUERY_TAG,
	CASE WHEN ERROR_CODE IS NULL 
		THEN 'SUCCESS' ELSE 'FAILURE' 
		END 			AS EXECUTION_STATUS,
	ERROR_CODE,
	ERROR_MESSAGE,
	START_TIME,
	END_TIME,
	TOTAL_ELAPSED_TIME,
	-- DETAIL
	BYTES_SCANNED,
	PERCENTAGE_SCANNED_FROM_CACHE,
	BYTES_WRITTEN,
	BYTES_WRITTEN_TO_RESULT,
	BYTES_READ_FROM_RESULT,
	ROWS_PRODUCED,
	ROWS_INSERTED,
	ROWS_UPDATED,
	ROWS_DELETED,
	ROWS_UNLOADED,
	BYTES_DELETED,
	PARTITIONS_SCANNED,
	PARTITIONS_TOTAL,
	BYTES_SPILLED_TO_LOCAL_STORAGE,
	BYTES_SPILLED_TO_REMOTE_STORAGE,
	BYTES_SENT_OVER_THE_NETWORK,
	COMPILATION_TIME,
	EXECUTION_TIME,
	QUEUED_PROVISIONING_TIME,
	QUEUED_REPAIR_TIME,
	QUEUED_OVERLOAD_TIME,
	TRANSACTION_BLOCKED_TIME,
	OUTBOUND_DATA_TRANSFER_CLOUD,
	OUTBOUND_DATA_TRANSFER_REGION,
	OUTBOUND_DATA_TRANSFER_BYTES,
	INBOUND_DATA_TRANSFER_CLOUD,
	INBOUND_DATA_TRANSFER_REGION,
	INBOUND_DATA_TRANSFER_BYTES,
	LIST_EXTERNAL_FILES_TIME,
	CREDITS_USED_CLOUD_SERVICES,
	RELEASE_VERSION,
	EXTERNAL_FUNCTION_TOTAL_INVOCATIONS,
	EXTERNAL_FUNCTION_TOTAL_SENT_ROWS,
	EXTERNAL_FUNCTION_TOTAL_RECEIVED_ROWS,
	EXTERNAL_FUNCTION_TOTAL_SENT_BYTES,
	EXTERNAL_FUNCTION_TOTAL_RECEIVED_BYTES,
	QUERY_LOAD_PERCENT,
	IS_CLIENT_GENERATED_STATEMENT
FROM
    TABLE($QUERY_HISTORY)
WHERE
    START_TIME BETWEEN $TS_START AND $TS_END --AND
--    USER_NAME = USER_NAME AND
--    QUERY_ID = $QUERY_ID AND
--	SESSION_ID = $SESSION_ID
AND QUERY_TYPE IN ('INSERT','UPDATE','MERGE','DELETE','DROP','TRUNCATE','COPY') 
ORDER BY
    SESSION_ID,START_TIME
LIMIT 1000
;



